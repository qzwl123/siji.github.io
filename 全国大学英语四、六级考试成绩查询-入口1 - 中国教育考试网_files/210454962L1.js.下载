var serv = new Object();
serv.protocol = document.location.protocol
serv.requestUrl = serv.protocol + "//appquery.neea.edu.cn";
serv.memberLoginUrl = "https://member.neea.cn";
serv.indexUrl = serv.protocol + "//www.neea.edu.cn/";
serv.IEVersion = IEVersion();

serv.setUser= function (data) {
    this.user = data;
};

serv.getUser = function () {
    return this.user || {};
};

serv.cjdd=function(subject,code,tab)
{
    return DICT_CJDD[subject][code];
};

/**
 * 获取用户欢迎信息
 */
serv.getUserData = function (validateLogin) {
    var url = serv.requestUrl + "/api/user/data?t="+Math.floor(new Date().getTime());
    $ajax("post", url, null, false, function (result) {
        if (!result || (result.code && result.code == 401) || !result.name) {
            if(validateLogin) {
                //去登录
                goLogin();
            }
        } else {
            serv.setUser(result);
        }
    });
};

/**
 * 加载当前用户
 */
serv.loadCurrentUser = function (validateLogin) {
    var userBean = serv.getUser();
    if ($.isEmptyObject(userBean)) {
        if(validateLogin) {
            //去登录
            goLogin();
        }
    } else {
        $("#xm").val(userBean.name);
        //$("#_xm").html(userBean.name);
        $("#sfz").val(userBean.certNo);
        //显示用户信息
        $("#welcome").append("欢迎您：");
        $("#welcome").append("<a href=\"https://member.neea.cn/userCenter/userInfo\" target=\"_blank\">"+userBean.name+"</a>&nbsp;&nbsp;");
        $("#welcome").append("<a href=\"javascript:serv.userLogout()\" class=\"but\" style=\"float:none\">退出</a>");
    }
};

/**
 * 用户退出登录
 */
serv.userLogout = function () {
    var url = serv.requestUrl + "/api/login/logout";
    $get(url, null, false, function (result) {
        location.href = serv.indexUrl;
    });
}
/**
 * 根据是否是小语种判断查询条件文字
 */
serv.selectToZSBH = function(){
    var subject = $("#subject").val();
    if("CET4,CET6,CET-SET".indexOf(subject)!=-1){
        $("#query_cjbgd").html("成绩报告单编号");
    }else{
        $("#query_cjbgd").html("证书编号");
    }

}

/**
 * 获取验证码
 * @param t 图片元素
 */
serv.verifys = function (t) {
    if(!t){
        t = $("#img_verifys");
    }
    $(t).hide().attr("src", serv.requestUrl + "/api/verify/get?t=" + Math.random()).fadeIn();
};

/**
 * 校验是否含有特殊字符
 * @param s 校验的字符串
 * @returns boolean{含有？}
 */
serv.containSpecial = function (s) {
    if (!s)
        return true;
    //var reg = new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>/?~！@#￥……&*（）—|{}【】‘；：”“'。，、？]");
    //var reg = new RegExp("[`~!@#$^&*()=|{}':;',\\[\\]<>/?~！@#￥……&*（）—|{}【】‘；：”“'。，、？]");
    //var reg = new RegExp("[`~!@#$^&*=|{}':;',\\[\\]<>/?~！@#￥……&*—|{}【】‘；：”“'。，、？]");
    //var reg = new RegExp("[`~!@#$^&*=|{}':;',\\[\\]<>/！@#￥……&*—|{}【】‘；：”“'。，、]");
    //var reg = new RegExp("[`~!@#$^&*=|{}:;\\[\\]<>/！@#￥……&*—|{}【】‘；：”“。，、]");
    var reg = new RegExp("[`~!@#$^&=|{}:;\\[\\]<>/！@#￥&—|{}【】‘；：”“。，、]");
    return reg.test(s);
};

/**
 * 校验是否含有空格
 * @param s 校验的字符串
 * @returns boolean{含有？}
 */
serv.containSpace = function (s) {
    var reg = new RegExp(/\s/g);
    return reg.test(s)
};

/**
 * 校验查询条件
 * @param t 校验的元素
 * @param f 是否验证 “中间是否有空格”
 * @returns boolean{校验通过？}
 */
serv.checkCondion = function (t, f) {
    var alt = $(t).attr("alt");
    var name = $(t).attr("name");
    var val = $(t).val();
    val = val.trim();
    var errorName = name + "_err";
    var errorObj = $("#" + errorName);
    if (errorObj) {
        if (errorObj.html()) errorObj.html("");
    } else {
        return false;
    }
    var err = "";
    if (val) {
        if (serv.containSpecial(val)) err = "“" + alt + "”格式错误";
    } else err = "“" + alt + "”不能为空";
    if (!err) {
        if (f == true) {
            if (serv.containSpace(val)) err = "“" + alt + "”中间不能有空格";
        }
    }
    if (err) {
        errorObj.html(err);
        return false;
    }
    return true;
};

/**
 * 校验验证码
 * @returns boolean{校验通过？}
 */
serv.checkVerify = function () {
    var verify = $("#verify").val();
    $("#verify_err").html("");
    if(!verify || verify.length!=4){
        $("#verify_err").html("请输入四位有效验证码！");
        return false;
    }
    return true;
};

serv.gotoQueryCondition = function () {
    $("#verify").val(""); serv.verifys();
    $("#achievement-thead").html("");
    $("#achievement-tbody").html("");
    $(".condition").show();
    $(".achievement").hide();
    $(".schrep").hide();
    $(".cjd").hide();
};

serv.gotoQueryAchievement = function () {
    $(".achievement").show();
    $(".schrep").hide();
    $(".cjd").hide();
};
/**
 * 查询cet成绩列表
 * @returns {boolean}
 */
serv.queryCetResultcenterList = function () {
    if (!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/results/centerList';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            if (result.code == 401) {
                goLogin();
                return;
            }
            layer.msg(result.message||result.msg);;
            return;
        }
        var subjectName = $("#subject").find("option:selected").text();
        $("#achievement-sn").html(subjectName);
        var showFields = rule_list[subject];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam_dt" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.data;
        var oneDataBean = data[0];
        $("#tit-xm").html(oneDataBean.xm);
        $("#tit-sfz").html(oneDataBean.sfz);
        $.each(data, function (index, bean) {
            _tr = $("<tr></tr>");
            $.each(showFields, function (code, name) {
                var fieldVal = bean[code] ? bean[code] : "--";
                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });
            var _tda = $("<a href=\"#\">查看详情</a>");
            _tda.click(function () {
                bean.state=0;
                serv.pdfData(bean);
                //serv.queryCetResult(bean.subject, bean.tab, bean.exam, bean.token);
            });
            _td = $("<td></td>");
            _tda.appendTo(_td);
            _td.appendTo(_tr);
            _tr.appendTo(achievementTbody);
        });
        if (subject == 'CET4' || subject == 'CET6' || subject == 'CET-SET') {
            $(".cetSetRemark").show();
        } else {
            $(".cetSetRemark").hide();
        }
        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};
/**
 * 查询cet成绩列表
 * @returns {boolean}
 */
serv.queryCetResultList = function () {
    if (!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/results/list';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            if (result.code == 401) {
                goLogin();
                return;
            }
            layer.msg(result.message||result.msg);;
            return;
        }
        var subjectName = $("#subject").find("option:selected").text();
        $("#achievement-sn").html(subjectName);
        var showFields = rule_list[subject];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam_dt" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.data;
        var oneDataBean = data[0];
        $("#tit-xm").html(oneDataBean.xm);
        $("#tit-sfz").html(oneDataBean.sfz);
        $.each(data, function (index, bean) {
            _tr = $("<tr></tr>");
            $.each(showFields, function (code, name) {
                var fieldVal = bean[code] ? bean[code] : "--";
                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });
            var _tda = $("<a href=\"#\">查看详情</a>");
            _tda.click(function () {
                serv.queryCetResult(bean.subject, bean.tab, bean.exam, bean.token);
            });
            _td = $("<td></td>");
            _tda.appendTo(_td);
            _td.appendTo(_tr);
            _tr.appendTo(achievementTbody);
        });
        if (subject == 'CET4' || subject == 'CET6' || subject == 'CET-SET') {
            $(".cetSetRemark").show();
        } else {
            $(".cetSetRemark").hide();
        }
        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};

/**
 * 查看cet成绩详情
 * @param subject
 * @param tab
 * @param token
 */
serv.queryCetResult = function (subject, tab, exam, token) {
    var url = serv.requestUrl + '/api/results/data';
    var params = {"token": token};
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            if (result.code == 401) {
                goLogin();
                return;
            }
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }
        var cjdObjName = dataBean.CJD_TEMPL;
        var cjdObj = $("#" + cjdObjName);
        if (cjdObj) {
            var sn = dataBean.SN;
            $("#schrep-sn").html(sn);
            $.each(dataBean, function (key, val) {
                var obj = $("[code=" + key + "]", cjdObj);
                if (obj.length) {
                    obj.html(val);
                }
            });
            //字段[KY_SCO]“口语等级”（英语四六级）特殊处理
            var kySco = $("[code=KY_SCO]", cjdObj);
            if (kySco.length) {
                if(dataBean["KY_SCO"] != '--'){
                    kySco.html("<strong>"+dataBean["KY_SCO"]+"</strong>");
                } else {
                    kySco.html("--");
                }
            }
            //字段[BEIZHU]“听力免考提示”特殊处理
            var beizhuObj = $("[code=BEIZHU]", cjdObj);
            if (beizhuObj.length) {
                if (dataBean["BEIZHU"]) {
                    beizhuObj.show();
                } else {
                    beizhuObj.hide();
                }
            }
            //字段[ID/SET_ID]“证书编号”或“成绩报告单编号”特殊处理
            var idFieldName = dataBean.hasOwnProperty("CET-SET") ? "SET_ID" : "ID";//subject == 'CET-SET' ? "SET_ID" : "ID";
            var idObj = $("[code="+idFieldName+"]", cjdObj);
            if (idObj.length) {
                if (dataBean[idFieldName]) {
                    idObj.parent().show();
                } else {
                    idObj.parent().hide();
                }
            }

            var photoObj = $("[code=photo]", cjdObj);
            if (photoObj.length) {
                if (dataBean.poken) {
                    photoObj.attr("src", serv.requestUrl + "/api/results/photo?poken=" + dataBean.poken);
                } else {
                    photoObj.error();
                }
            }

            $(".schrep").show();
            cjdObj.show();
            $(".achievement").hide();
            //详情查询成功统计
            _hmt.push(['_trackEvent', 'data', 'result', subject+'-qs', 1]);
        }
        //layer.alert("<textarea cols=40 rows=8>"+JSON.stringify(result,null,2)+"</textarea>");
    });
};

/**
 * 查询cet其他
 * @returns {boolean}
 */
serv.queryCetOtherResult = function () {
    if (!serv.checkCondion($("#xm")) || !serv.checkCondion($("#zsbh")) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    var zsbh = $("#zsbh").val();
    var xm = $("#xm").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "zsbh": zsbh, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //var params = {"subject": encodeURIComponent(subject), "zsbh": encodeURIComponent(zsbh), "xm": encodeURIComponent(xm), "verify": encodeURIComponent(verify)};
    //其他查询统计
    /*_hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'data', 'click', subject+'-qother', 1]);*/
    var url = serv.requestUrl + '/api/results/otherData';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }
        var cjdObjName = dataBean.CJD_TEMPL;
        var cjdObj = $("#" + cjdObjName);
        if (cjdObj) {
            var sn = dataBean.SN;
            $("#schrep-sn").html(sn);
            $.each(dataBean, function (key, val) {
                var obj = $("[code=" + key + "]", cjdObj);
                if (obj.length) {
                    obj.html(val);
                }
            });
            //字段[KY_SCO]“口语等级”（英语四六级）特殊处理
            var kySco = $("[code=KY_SCO]", cjdObj);
            if (kySco.length) {
                if(dataBean["KY_SCO"] != '--'){
                    kySco.html("<strong>"+dataBean["KY_SCO"]+"</strong>");
                } else {
                    kySco.html("--");
                }
            }
            //字段[BEIZHU]“听力免考提示”特殊处理
            var beizhuObj = $("[code=BEIZHU]", cjdObj);
            if (beizhuObj.length) {
                if (dataBean["BEIZHU"]) {
                    beizhuObj.show();
                } else {
                    beizhuObj.hide();
                }
            }
            //字段[ID/SET_ID]“证书编号”或“成绩报告单编号”特殊处理
            var idFieldName = dataBean.hasOwnProperty("CET-SET") ? "SET_ID" : "ID";//subject == 'CET-SET' ? "SET_ID" : "ID";
            var idObj = $("[code="+idFieldName+"]", cjdObj);
            if (idObj.length) {
                if (dataBean[idFieldName]) {
                    idObj.parent().show();
                } else {
                    idObj.parent().hide();
                }
            }

            var photoObj = $("[code=photo]", cjdObj);
            if (photoObj.length) {
                if (dataBean.poken) {
                    photoObj.attr("src", serv.requestUrl + "/api/results/photo?poken=" + dataBean.poken);
                } else {
                    photoObj.error();
                }
            }

            $(".schrep").show();
            cjdObj.show();
            $(".condition").hide();
            //详情查询成功统计
            /*_hmt.push(['_trackEvent', 'data', 'result', subject+'-qsother', 1]);*/
        }
    });
    return false;
};



/**
 * 查询PETS成绩列表
 * @returns {boolean}
 */
serv.queryPETSResultList = function () {
    if (!serv.checkCondion($("#xm"), true)||!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/results/list';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        var showFields = rule_list[subject];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam_dt" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.data;
        var oneDataBean = data[0];
        /*if(){

        }*/
        var subjectName = $("#subject").val();
        var  title = '全国英语等级考试（PETS）';
        $("#tit-xm").html(oneDataBean.xm);
        $("#tit-sfz").html(oneDataBean.sfz);
        $("#achievement-sn").html(title);

        $.each(data, function (index, bean) {
            //判断是否是当次，如果是当次则红色显示
            if(bean.tab==dq.tab){
                _tr = $("<tr></tr>");
            }else{
                _tr = $("<tr></tr>");
            }
            if(subjectName=="PETS")
            {
                if(bean.kszl=="0")bean.ky=null;//口试
                else if(bean.kszl=="1")bean.score=null;//笔试
            }
            $.each(showFields, function (code, name) {
                var fieldVal ;
                if(code=="sf"){
                    fieldVal = DICT_SFNAME[bean[code]];
                }else if(code=="bkjb"){
                    fieldVal = dict.getLevelName(bean);
                }else{
                    fieldVal = bean[code] ? bean[code] : "--";
                }

                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });
            var _tda = $("<a href=\"#\" style=\"padding-right: 10px;\">查看成绩</a>");
            _tda.click(function () {
                bean.state=0;
                serv.pdfData(bean);
                //serv.queryPETSResult(bean.subject, bean.tab, bean.exam, bean.token);
            });
            _td = $("<td></td>");
            _tda.appendTo(_td);
            _td.appendTo(_tr);

            var _tda = $("<a href=https://ecert.neea.edu.cn/api/pdf/down.pdf?tab="+bean.tab+"&token="+bean.token+"&state=0&dangci=true target=_ajax>下载成绩单</a>");
            _tda.mouseup(function()
            {
                _hmt.push(['_trackEvent', 'ecert', 'down', subject+'-d', 1]);
            });

            _tda.appendTo(_td);
            _td.appendTo(_tr);


            _tr.appendTo(achievementTbody);
        });
        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};
/**
 * 查看PETS成绩详情
 * @param subject
 * @param tab
 * @param token
 */
serv.queryPETSResult = function (subject, tab, exam, token) {
    var url="https://ecert.neea.edu.cn/api/pdf/data";
    var params = {tab:tab,token:token,state:0};
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }
        var subjectName = $("#subject").val();
        subjectName = '全国英语等级考试（PETS）';

        $("#schrep-sn").html(subjectName);
        $.each(dataBean, function (key, val) {
            var obj = $("[code=" + key + "]");
            if (obj.length) {
                obj.html(val);
            }
        });
        $(".schrep").show();
        $(".achievement").hide();

        //
        params.subject=subject;
        serv.pdf(params,result);

        //详情查询成功统计
        _hmt.push(['_trackEvent', 'data', 'result', subject+'-qs', 1]);

        //layer.alert("<textarea cols=40 rows=8>"+JSON.stringify(result,null,2)+"</textarea>");
    });
};


var subj={
    PETS:{name:"全国英语等级考试（PETS）",tab:["","PETS_202103"]},
    WSK :{name:"全国外语水平考试（WSK）",tab:["WSK_1911","WSK_202105"]},
    CET4:{name:"全国大学英语四级考试(CET4)",tab:[]},
    CET6:{name:"全国大学英语六级考试(CET6)",tab:[]},
    CJT4:{name:"全国大学日语四级考试(CJT4)",tab:[]},
    CJT6:{name:"全国大学日语六级考试(CJT6)",tab:[]},
    CRT4:{name:"全国大学俄语四级考试(CRT4)",tab:[]},
    CRT6:{name:"全国大学俄语六级考试(CRT6)",tab:[]},
    PHS4:{name:"全国大学德语四级考试(PHS4)",tab:[]},
    PHS6:{name:"全国大学德语六级考试(PHS6)",tab:[]},
    TFU4:{name:"全国大学法语四级考试(TFU4)",tab:[]},
    "CET-SET":{name:"全国大学英语四、六级口语考试（CET-SET）"}
};
if(!window.console)console={log:function(){},error:function(){}};

//什么时候开始提供下载
serv.isDown=function(par)
{
  try
  {
    //var tabs={PETS:["","PETS_202103"],WSK:["WSK_1911","WSK_202105"]};
    var down=par.tab>=subj[par.subject].tab[par.state];
    return down;
  }catch(e)
  {
    return false;
  }
};
serv.pdfData=function(par)
{
    var url="https://ecert.neea.edu.cn/api/pdf/data";
    url=serv.requestUrl+"/api/pdf/data";
    //var params = {tab:tab,token:token,state:1,dangci:false,params.subject};
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, {tab:par.tab, token:par.token, state:par.state, dangci:par.dangci||false}, true, function(ret)
    {
        layer.close(loadIndex);
        if(!ret)ret={code:500,msg:"获取数据错误！"};
        if (ret.code)
        {
            layer.msg(ret.message||ret.msg);
            return;
        }
        $(".condition,.achievement").hide();
        $(".schrep").show();

        //
        serv.pdf(par,ret);

        //详情查询成功统计
        _hmt.push(['_trackEvent', 'data', 'result', par.subject+'-qs', 1]);
    });
};

serv.pdf=function(par,ret)
{
    //标题
    $("#schrep-sn").html(subj[par.subject].name);

    //下载
    if(serv.isDown(par))
      $(".down").show();
    else
      $(".down").hide();

    $(".down").attr("href","https://ecert.neea.edu.cn/api/pdf/down.pdf?tab="+par.tab+"&token="+par.token+"&state="+par.state+"&dangci=true");
    $(".down").off().mouseup(function()
    {
        _hmt.push(['_trackEvent', 'ecert', 'down', par.subject+'-d', 1]);
    });

    //内容
    try
    {
        var li=ret.data,d0=li[0];
        if(serv.IEVersion>0&&serv.IEVersion<9)d0.bg=d0.bg.replace(".svg",".png");

        var htm="<img id=_BG src=//www.neea.edu.cn/query/"+d0.bg+">";
        var isNew=false;for(var i=0;i<li.length;i++)if(li[i].n=='_QR')isNew=true;
        var ALIGN=["left","center","right"];
        for(var i=0;i<li.length;i++)
        {
            var d=li[i];
            if(d.n=="_PHOTO")
            {
                d.v=d.v?serv.requestUrl+"/api/results/photo?poken="+d.v:"//www.neea.edu.cn/query/images/nophoto.jpg";
                //d.v=d.v?"https://ecert.neea.edu.cn/api/pdf/photo?token="+d.v:"//www.neea.edu.cn/query/images/nophoto.jpg";
                d.v="<img src="+d.v+" style="+(isNew?"max-width:73.7px;max-height:90.7px":"max-width:90px;max-height:120px")+">";
            }else if(d.n=="_QR")
            {
                var arale=new AraleQRCode({render:"table",text:d.v,correctLevel:0});
                var tr=arale.getElementsByTagName("TR");
                var size=tr.length;if(size<30)size*=2;
                arale.setAttribute("url",d.v);
                arale.setAttribute("size",size);//最小
                arale.setAttribute("nwidth",size*parseInt(tr[0].style.height));//实际
                d.y+=70-size;
                d.v=arale.outerHTML;
            }else if(d.n=="BSJB")
            {
                if(par.subject=="CET-SET")//调整标题
                {
                    var str=d.v.indexOf("四级")==-1?"四、":"、六";
                    str=subj[par.subject].name.replace(str,"");
                    $("#schrep-sn").html(str);
                }
            }else if(d.n=="KY_SCO")
            {
                if(d.v=="--")d.n="-";//去掉加粗、标红
            }

            if(!d.v||!d.x)continue;
            var css="";
            if(d.a)//对齐
            {
                if(d.a==1)d.x-=200;
                else if(d.a==2)d.x-=400;
                css+="width:400px;text-align:"+ALIGN[d.a]+";";
            }
            if(d.s)//字号
            {
                if(d.s==10)
                {
                    d.y-=2;
                    d.s+=2;
                }
                css+="font-size:"+d.s+"px;";
            }/*
            try
            {
              if(d.w!=undefined)//风格
              {
                if(d.w==2)
                    css+="font-style:italic;";
                else
                    css+="font-weight:"+["normal","bold"][d.w]+";";
              }
            }catch(e)
            {}*/
            htm+="<div id="+d.n+" style=left:"+d.x+"px;top:"+(d.y-(isNew?1:0))+"px;"+css+">"+d.v+"</div>";
        }

        $(".cbody").html(htm).css({width:d0.width+"px",height:d0.height+"px"});

        //浏览器缩放:二维码
        window.onresize();
    }catch(e)
    {
        console.log(e);
    }
};

window.onresize=function()
{
    var ar=$(".cbody #_QR");//71,size:49,默认:256
    if(ar.length)
    {
        var arale=ar.find("table");
        if(ar.width()==ar.height())
            arale=arale[0];
        else//浏览器放大比例不对
        {
            var size=arale.attr("size");
            arale=new AraleQRCode({text:arale.attr("url"),size:size*3,correctLevel:0});
            arale.style.cssText="width:"+size+"px;height:"+size+"px;";
            ar.html("");
            ar.append(arale);
        }

        var tips;
        ar.off().hover(function()
        {
            var size=parseInt(arale.width||arale.getAttribute("nwidth"));
            tips=layer.tips(arale.tagName=="TABLE"?arale.outerHTML:"<img src="+arale.toDataURL("image/png")+">",this,
            {
                tips:[4,"#fff"],time:0,area:[30+size+"px",16+size+"px"]
            });
        },function()
        {
            layer.close(tips);
            tips=0;
        });
    }
};

/**
 * 查询PETS证书列表
 * @returns {boolean}
 */
serv.queryPETSCERTList = function () {
    if (!serv.checkCondion($("#xm"), true)||!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/cert/list';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code!="0") {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }

        var showFields = rule_list["PETS_ZS"];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam_dt" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.data;
        var oneDataBean = data[0];
        /*if(){

        }*/
        var subjectName = $("#subject").val();
        var  title = '全国英语等级考试（PETS）';
        $("#tit-xm").html(oneDataBean.xm);
        $("#tit-sfz").html(oneDataBean.sfz);
        $("#achievement-sn").html(title);

        $.each(data, function (index, bean) {
            if(bean.tab==dq.tab){
                _tr = $("<tr></tr>");
            }else{
                _tr = $("<tr></tr>");
            }
            $.each(showFields, function (code, name) {
                var fieldVal ;
                if(code=="sf"){
                    fieldVal = DICT_SFNAME[bean[code]];
                }else if(code=="bkjb"){
                    fieldVal = dict.getLevelName(bean);
                }else{
                    fieldVal = bean[code] ? bean[code] : "--";
                }

                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });
            var _tda = $("<a href=\"#\" style=\"padding-right: 10px;\">查看证书</a>");
            _tda.click(function () {
                bean.state=1;
                serv.pdfData(bean);
                //serv.queryPETSCERT(bean.subject, bean.tab, bean.exam, bean.token);
            });
            _td = $("<td></td>");
            _tda.appendTo(_td);
            _td.appendTo(_tr);

            if(bean.subject=="PETS"){
                if(bean.tab >= "PETS_202103"){

                    var _tda = $("<a href=https://ecert.neea.edu.cn/api/pdf/down.pdf?tab="+bean.tab+"&token="+bean.token+"&state=1&dangci=true target=_ajax>下载合格证书</a>");
                    _tda.mouseup(function()
                    {
                        _hmt.push(['_trackEvent', 'ecert', 'down', subject+'-d', 1]);
                    });

                    _tda.appendTo(_td);
                    _td.appendTo(_tr);
                }
            }
            _tr.appendTo(achievementTbody);
        });
        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};
/**
 * 查看PETS证书详情
 * @param subject
 * @param tab
 * @param token
 */
serv.queryPETSCERT = function (subject, tab, exam, token) {
    var url="https://ecert.neea.edu.cn/api/pdf/data";
    var params = {tab:tab,token:token,state:1,dangci:false};
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }
        var subjectName = $("#subject").val();
        subjectName = '全国英语等级考试（PETS）';

        $("#schrep-sn").html(subjectName);
        $.each(dataBean, function (key, val) {
            var obj = $("[code=" + key + "]");
            if (obj.length) {
                obj.html(val);
            }
        });

        $(".schrep").show();
        $(".achievement").hide();

        //
        params.subject=subject;
        serv.pdf(params,result);

        //详情查询成功统计
        _hmt.push(['_trackEvent', 'data', 'result', subject+'-qs', 1]);

        //layer.alert("<textarea cols=40 rows=8>"+JSON.stringify(result,null,2)+"</textarea>");
    });
};
/**
 * 查询WSK成绩列表
 * @returns {boolean}
 */
serv.queryWSKResultList = function () {
    if (!serv.checkCondion($("#xm"), true)||!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/results/list';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            if (result.code == 401) {
                goLogin();
                return;
            }
            layer.msg(result.message||result.msg);
            return;
        }
        var showFields = rule_list[subject];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam_dt" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.data;
        var oneDataBean = data[0];
        var subjectName = $("#subject").val();
        var  title = '全国外语水平考试（WSK）';
        $("#tit-xm").html(oneDataBean.xm);
        $("#tit-sfz").html(oneDataBean.sfz);
        $("#achievement-sn").html(title);

        $.each(data, function (index, bean) {
            _tr = $("<tr></tr>");
            $.each(showFields, function (code, name) {
                var fieldVal ;
                if(code=="bkjb"){
                    fieldVal = dict.getLevelName(bean);
                }else{
                    fieldVal = bean[code] ? bean[code] : "--";
                }

                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });
            _td = $("<td></td>");
            _td.appendTo(_tr);
            _tr.appendTo(achievementTbody);

            if(bean.tab<"WSK_1911"){_td.append("--");return;}
            var _tda = $("<a href=\"#\" style=\"padding-right: 10px;\">查看成绩</a>");
            _tda.click(function () {
                bean.state=0;
                serv.pdfData(bean);
                //serv.queryWSKResult(bean.subject, bean.tab, bean.exam, bean.token);
            });
            _tda.appendTo(_td);

            var _tda = $("<a href=https://ecert.neea.edu.cn/api/pdf/down.pdf?tab="+bean.tab+"&token="+bean.token+"&state=0&dangci=true target=_ajax>下载成绩单</a>");
            _tda.mouseup(function()
            {
                _hmt.push(['_trackEvent', 'ecert', 'down', subject+'-d', 1]);
            });
            _tda.appendTo(_td);
        });
        $(".cetSetRemark").hide();
        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};


/**
 * 查看WSK成绩详情
 * @param subject
 * @param tab
 * @param token
 */
serv.queryWSKResult = function (subject, tab, exam, token) {
    var url="https://ecert.neea.edu.cn/api/pdf/data";
    var params = {tab:tab,token:token,state:0,dangci:false};
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }
        var subjectName = $("#subject").val();
        subjectName = '全国外语水平考试（WSK）';

        $("#schrep-sn").html(subjectName);
        $.each(dataBean, function (key, val) {
            var obj = $("[code=" + key + "]");
            if (obj.length) {
                obj.html(val);
            }
        });

        $(".schrep").show();
        $(".achievement").hide();

        //
        params.subject=subject;
        serv.pdf(params,result);

        //详情查询成功统计
        _hmt.push(['_trackEvent', 'data', 'result', subject+'-qs', 1]);

        //layer.alert("<textarea cols=40 rows=8>"+JSON.stringify(result,null,2)+"</textarea>");
    });
};
/**
 * 查看WSK证书列表
 * @param subject
 * @param tab
 * @param token
 */
serv.queryWSKCERTList = function () {
    if (!serv.checkCondion($("#xm"), true)||!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/cert/list';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code!="0") {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }

        var showFields = rule_list["WSK_ZS"];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam_dt" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.data;
        var oneDataBean = data[0];
        var subjectName = $("#subject").val();
        var  title = '全国外语水平考试（WSK）';
        $("#tit-xm").html(oneDataBean.xm);
        $("#tit-sfz").html(oneDataBean.sfz);
        $("#achievement-sn").html(title);

        $.each(data, function (index, bean) {
            _tr = $("<tr></tr>");
            $.each(showFields, function (code, name) {
                var fieldVal ;
                if(code=="bkjb"){
                    fieldVal = dict.getLevelName(bean);
                }else{
                    fieldVal = bean[code] ? bean[code] : "--";
                }

                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });
            _td = $("<td></td>");
            _td.appendTo(_tr);
            _tr.appendTo(achievementTbody);


            var _tda = $("<a href=\"#\" style=\"padding-right: 10px;\">查看证书</a>");
            _tda.click(function()
            {
                bean.state=1;
                serv.pdfData(bean);
                //serv.queryWSKCERT(bean.subject, bean.tab, bean.exam, bean.token);
            });
            _tda.appendTo(_td);

            if(bean.tab<"WSK_202105")return;
            //if(bean.tab<"WSK_202011")return;
            var _tda = $("<a href=https://ecert.neea.edu.cn/api/pdf/down.pdf?tab="+bean.tab+"&token="+bean.token+"&state=1&dangci=true target=_ajax>下载合格证书</a>");
            _tda.mouseup(function()
            {
                _hmt.push(['_trackEvent', 'ecert', 'down', subject+'-d', 1]);
            });
            _tda.appendTo(_td);
        });
        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};

/**
 * 查看WSK证书详情
 * @param subject
 * @param tab
 * @param token
 */
serv.queryWSKCERT = function (subject, tab, exam, token) {
    var url="https://ecert.neea.edu.cn/api/pdf/data";
    var params = {tab:tab,token:token,state:1,dangci:false};
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }
        var subjectName = $("#subject").val();
        subjectName = '全国外语水平考试（WSK）';

        $("#schrep-sn").html(subjectName);
        $.each(dataBean, function (key, val) {
            var obj = $("[code=" + key + "]");
            if (obj.length) {
                obj.html(val);
            }
        });

        $(".schrep").show();
        $(".achievement").hide();

        //
        params.subject=subject;
        serv.pdf(params,result);

        //详情查询成功统计
        _hmt.push(['_trackEvent', 'data', 'result', subject+'-qs', 1]);

        //layer.alert("<textarea cols=40 rows=8>"+JSON.stringify(result,null,2)+"</textarea>");
    });
};
/**
 * 查询NTCE成绩列表
 * @returns {boolean}
 */
serv.queryNTCEResultList = function () {
    if (!serv.checkCondion($("#sfz"), true)||!serv.checkCondion($("#xm"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/results/list';
    var loadIndex = layer.load(0, {shade: 0.1});

    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        //console.log(result)

        var showFields_bs = rule_list["NTCE_BS"];
        var showFields_ms = rule_list["NTCE_MS"];
        //console.log(code + ":" + name);
        //笔试成绩
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");

        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields_bs, function (code, name) {
            var width;
            switch (code) {
                case "kmname" : width="20%"
                    break;
                case "bgf" : width="10%"
                    break;
                case "hg" : width=""
                    break;
                case "zkzh" : width="18%"
                    break;
                case "exam" : width="15%"
                    break;
                case "yxq" : width="17%"
                    break;
                case "sf" : width="10%"
                    break;
            }
            _th = $("<th style=\"width: "+width+";\">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);


        var data = result.bs.bsdata;
        if(data.length!=0){
            var oneDataBean = data[0];

            $("#tit-xm").html(oneDataBean.xm);
            $("#tit-sfz").html(oneDataBean.sfz);
        }

        $.each(data, function (index, bean) {
            _tr = $("<tr style='height=\"25\"'></tr>");
            $.each(showFields_bs, function (code, name) {
                var fieldVal = bean[code] ? bean[code] : "--";
                _td = $("<td>" + fieldVal + "</td>");
                _td.appendTo(_tr);
            });

            _td.appendTo(_tr);
            _tr.appendTo(achievementTbody);
        });




        var data = result.ms.msdata;
        if(data.length!=0){
            //面试成绩
            var achievementTheadM = $("#achievement-thead-m");
            var achievementTbodyM = $("#achievement-tbody-m");
            achievementTheadM.html("");
            achievementTbodyM.html("");
            $("#mscj").html("面试成绩");
            $("#bz").html("备注：");
            $("#bzcon").html("面试合格与否由各省教育行政部门确定。");

            var _tr = $("<tr style=\"background: #c0a274 !important;color:#FFFFFF;\"></tr>");
            var _th, _td;
            $.each(showFields_ms, function (code, name) {
                var width;
                switch (code) {
                    case "kmname" : width="25%"
                        break;
                    case "hg" : width=""
                        break;
                    case "zkzh" : width="30%"
                        break;
                    case "exam" : width="15%"
                        break;
                    case "sf" : width="10%"
                        break;
                }
                _th = $("<th style=\"width: "+width+";\">" + name + "</th>");
                _th.appendTo(_tr);
            });
            _th.appendTo(_tr);
            _tr.appendTo(achievementTheadM);

            var oneDataBean = data[0];

            $("#tit-xm").html(oneDataBean.xm);
            $("#tit-sfz").html(oneDataBean.sfz);

            $.each(data, function (index, bean) {
                _tr = $("<tr style='height=\"25\"'></tr>");
                $.each(showFields_ms, function (code, name) {
                    var fieldVal = bean[code] ? bean[code] : "--";
                    _td = $("<td>" + fieldVal + "</td>");
                    _td.appendTo(_tr);
                });

                _td.appendTo(_tr);
                _tr.appendTo(achievementTbodyM);
            });
        }else{
            var achievementTheadM = $("#achievement-thead-m");
            var achievementTbodyM = $("#achievement-tbody-m");
            achievementTheadM.html("");
            achievementTbodyM.html("");
            $("#mscj").html("");
            $("#bz").html("");
            $("#bzcon").html("");
        }


        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};

/**
 * 查询NTCE证书列表
 * @returns {boolean}
 */
serv.queryNTCECERTList = function () {
    if (!serv.checkCondion($("#xm"), true)||!serv.checkCondion($("#sfz"), true) || !serv.checkVerify()) {
        return false;
    }
    //获取参数
    var subject = $("#subject").val();
    //var xm = $("#_xm").text();
    var xm = $("#xm").val();
    var sfz = $("#sfz").val();
    var verify = $("#verify").val();
    var params = {"subject": subject, "xm": xm, "sfz": sfz, "verify": verify};//test
    //right var params = {"subject": subject, "sfz": sfz, "verify": verify};
    //var params = "subject=" + encodeURIComponent(subject) + "&xm=" + encodeURIComponent(xm) + "&sfz=" + encodeURIComponent(sfz) + "&verify=" + encodeURIComponent(verify);
    //var params = {"subject": encodeURIComponent(subject), "xm": encodeURIComponent(xm), "sfz": encodeURIComponent(sfz), "verify": encodeURIComponent(verify)};
    //111var params = {"subject": encodeURIComponent(subject), "sfz": encodeURICo83mponent(sfz), "verify": encodeURIComponent(verify)};
    //列表查询统计
    _hmt.push(['_setAccount', 'dc1d69ab90346d48ee02f18510292577']);
    _hmt.push(['_trackEvent', 'list', 'click', subject+'-q', 1]);
    var url = serv.requestUrl + '/api/cert/list';
    var loadIndex = layer.load(0, {shade: 0.1});
    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        serv.verifys();
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            if (result.code == 401) {
                goLogin();
                return;
            }
            layer.msg(result.message||result.msg);
            return;
        }
        var showFields = rule_list[subject];
        //console.log(code + ":" + name);
        var achievementThead = $("#achievement-thead");
        var achievementTbody = $("#achievement-tbody");
        achievementThead.html("");
        achievementTbody.html("");
        var _tr = $("<tr style=\"background:rgb(13, 163, 226);color:#FFFFFF;\"></tr>");
        var _th, _td;
        $.each(showFields, function (code, name) {
            _th = $("<th "+(code == "exam" ? "style=\"width: 300px;\"" : "")+">" + name + "</th>");
            _th.appendTo(_tr);
        });
        _th = $("<th>操作</th>");
        _th.appendTo(_tr);
        _tr.appendTo(achievementThead);

        var data = result.zs.zsdata;
        var oneDataBean = data[0];

        var subjectName = $("#subject").val();
        var hre = '';
        if(subjectName=='NTCE'){
            subjectName = '中小学教师资格考试（NTCE）';
            $("#tit-xm").html(oneDataBean.xm);
            $("#tit-sfz").html(oneDataBean.sfz);
        }
        $("#achievement-sn").html(subjectName);
        $.each(data, function (index, bean) {
            _tr = $("<tr></tr>");
            $.each(showFields, function (code, name) {
                var fieldVal;
                if(code=="sf"){
                    fieldVal = DICT_SFNAME[bean[code]];
                    _td = $("<td>" + fieldVal + "</td>");
                }else if(code=="yxq"){
                    fieldVal = bean[code];
                    _td = $("<td>" + fieldVal + "</td>");
                }else{
                    fieldVal = bean[code] ? bean[code] : "--";
                    _td = $("<td>" + fieldVal + "</td>");
                }

                _td.appendTo(_tr);
            });
                //拼接下载pdf链接
                hre = "&psid=&subjectId=660&subjectCode=NTCE&examId="+bean.exam_id+"&name="+bean.xm+"&sfzh="+bean.sfz+"&zkzh="+bean.zkzh+"&sf="+bean.sf+"&bkjb="+bean.bkjb+"&pdfName=NTCE";
            var href = "//search.neea.edu.cn/QueryDataAction.do?act=downQueryPdf&pram=certi"+hre;
            var _tdad = $("<a target='_blank' href=\""+href+"\" style=\"padding-right: 10px;\">下载证书</a>");
            _td = $("<td></td>");
            _tdad.appendTo(_td);
            _td.appendTo(_tr);

            var _tda = $("<a href=\"#\">查看证书</a>");
            _tda.click(function () {
                serv.queryNTCECERT(bean.subject, bean.tab, bean.exam, bean.token,bean.exam_id);
            });
            _tda.appendTo(_td);
            _td.appendTo(_tr);
            _tr.appendTo(achievementTbody);
        });

        $(".achievement").show();
        $(".condition").hide();
        $(".schrep").hide();
        $(".cjd").hide();
        //列表查询成功统计
        _hmt.push(['_trackEvent', 'list', 'result', subject+'-qs', 1]);
    });
    return false;
};

/**
 * 查看证书详情
 * @param subject
 * @param tab
 * @param token
 */
serv.queryNTCECERT = function (subject, tab, exam, token,exam_id) {
    //获取成绩详情
    var url = serv.requestUrl + '/api/cert/data';
    var params = {"token": token};
    //获取照片路径
    var getPhotoUrl = '//appquery.neea.edu.cn/api/cert/photo';


    var loadIndex = layer.load(0, {shade: 0.1});


    $ajax("post", url, params, true, function (result) {
        layer.close(loadIndex);
        if(!result){
            layer.msg("获取数据错误！");
            return;
        }
        if (result.code) {
            //如果为未登录，则跳转到登录页
            /*if (result.code == 401) {
                goLogin();
                return;
            }*/
            layer.msg(result.message||result.msg);
            return;
        }
        var dataBean = result.data;
        if ($.isEmptyObject(dataBean)) {
            layer.msg("获取数据为空错误！");
            return;
        }

        //获取照片路径
        var photoObj = $("#photo");
        if (dataBean.poken) {
            photoObj.attr("src", "//appquery.neea.edu.cn/api/cert/photo?poken=" + dataBean.poken);
        } else {
            photoObj.attr("src","//www.neea.edu.cn/query/images/nophoto.jpg");
        }

        var subjectName = $("#subject").val();
        if(subjectName=='NTCE'){
            subjectName = '中小学教师资格考试合格证明(NTCE)';

            $("#act").val("downQueryPdf");
            $("#pram").val("certi");
            $("#psid").val("");
            $("#subjectId").val("660");
            $("#subjectCode").val("NTCE");
            $("#examId").val(exam_id);
            $("#name").val(dataBean.XM);
            $("#sfzh").val(dataBean.SFZH);
            $("#zkzh").val(dataBean.ZKZH);
            $("#sf").val(dataBean.SF);
            $("#bkjb").val(dataBean.JB);
            $("#pdfName").val("NTCE");
        }
        $("#schrep-sn").html(subjectName);
        $.each(dataBean, function (key, val) {
            var obj = $("[code=" + key + "]");
            if (obj.length) {
                obj.html(val);
            }
        });


        $(".schrep").show();
        $(".achievement").hide();
        //详情查询成功统计
        _hmt.push(['_trackEvent', 'data', 'result', subject+'-qs', 1]);

        //layer.alert("<textarea cols=40 rows=8>"+JSON.stringify(result,null,2)+"</textarea>");
    });
};



/**
 * 获取考次时间数字
 * @param tab
 * @returns {null|number}
 */
serv.getKcnum = function (tab) {
    try {
        if (tab && tab.indexOf("_") != -1) {
            return parseInt(tab.substring(tab.indexOf("_")+1));
        }
    } catch (e) {}
    return null;
};

/**
 * 获取考试时间
 * @param tab
 * @returns {string|null}
 */
serv.queryCetDt = function (tab) {
    var kcnum = serv.getKcnum(tab);
    if (kcnum == null) {
        return null;
    }
    var kcnumStr = kcnum < 100 ? ("0" + kcnum) : (kcnum + "");
    if(kcnumStr.length != 3){
        return null;
    }
    var yearShort = kcnumStr.substring(0,2);
    var haftYearNum = kcnumStr.charAt(2);
    return "20" + yearShort + "年" + (haftYearNum == 1 ? "上" : "下") + "半年";
};

// 封装get请求
function $get(url, data, async, callback) {
    jQuery.support.cors = true;//浏览器支持跨域访问
    $.ajax({
        url: url,
        type: 'get',
        async: async,
        data:data,
        //允许请求携带cookie信息
        xhrFields: {withCredentials: true},
        success: function (data) {
            if(callback) {
                callback(data);
            }
        },
        error: function (re) {
            if (window.layer) {
                layer.closeAll();
                layer.msg('数据错误!');
            } else {
                alert('数据错误!');
            }
        }
    })
}

// 封装get jsonp请求
function $getp(url, data, async, callback) {
    $.ajax({
        url: url,
        type: 'get',
        async: async,
        data:data,
        dataType: 'jsonp',
        jsonp: "cb",
        success: function (data) {
            if(callback) {
                callback(data);
            }
        },
        error: function (re) {
            if (window.layer) {
                layer.closeAll();
                layer.msg('数据错误!');
            } else {
                alert('数据错误!');
            }
        }
    })
}

// 封装post请求
function $post(url, data, async, callback) {
    jQuery.support.cors = true;//浏览器支持跨域访问
    $.ajax({
        url: url,
        type: 'post',
        async: async,
        data:data,
        //允许请求携带cookie信息
        xhrFields: {withCredentials: true},
        success: function (data) {
            if(callback) {
                callback(data);
            }
        },
        error: function (re) {
            if (window.layer) {
                layer.closeAll();
                layer.msg('数据错误!');
            } else {
                alert('数据错误!');
            }
        }
    })
}

function $ajax(type, url, data, async, callback) {
    type = type == null ? "get" : type;
    if (serv.IEVersion > 0 && serv.IEVersion < 10) {
        $getp(url, data, async, callback);
    } else {
        if (type.toLowerCase() == "get") {
            $get(url, data, async, callback);
        } else if (type.toLowerCase() == "post") {
            $post(url, data, async, callback);
        }
    }
}

/**
 * 替换字符串中可能包含的xss攻击的脚本
 *
 * @param str
 *            传入的字符串
 * @returns
 */
function cleanXSS(str) {
    str = str.replace(/<script>(.*?)<\/script>/g, "");
    str = str.replace(/<\/script>/g, "");
    str = str.replace(/<script(.*?)>/g, "");
    str = str.replace(/eval\((.*?)\)/g, "");
    str = str.replace(/e­xpression\((.*?)\)/g, "");
    str = str.replace(/javascript:/g, "");
    str = str.replace(/vbscript:/g, "");
    str = str.replace(/onload(.*?)=/g, "");
    return str;
}

function goLogin() {
    // 防止DOM的XSS攻击
    var redirectUrl = encodeURIComponent(cleanXSS(location.href));
    var returnUrl = encodeURIComponent(serv.requestUrl + "/api/login/validateMemberUser?redirectUrl=" + redirectUrl);
    var loginUrl = serv.memberLoginUrl + "/login/new?threeView=requirePrams&returnUrl=" + returnUrl;
    location.href = loginUrl;
}

// 判断IE浏览器版本
function IEVersion() {
    var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
    var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器
    var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器
    var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
    if(isIE) {
        var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
        reIE.test(userAgent);
        var fIEVersion = parseFloat(RegExp["$1"]);
        if(fIEVersion == 7) {
            return 7;
        } else if(fIEVersion == 8) {
            return 8;
        } else if(fIEVersion == 9) {
            return 9;
        } else if(fIEVersion == 10) {
            return 10;
        } else {
            return 6;//IE版本<=7
        }
    } else if(isEdge) {
        return 'edge';//edge
    } else if(isIE11) {
        return 11; //IE11
    }else{
        return -1;//不是ie浏览器
    }
}
